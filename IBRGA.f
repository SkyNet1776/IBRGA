C     LEGACY STANDARD, F77
      PROGRAM IBRGAC
      CHARACTER BDFILE*10,OUTFIL*10
      DIMENSION BR(10),TRAV(10),RP(10),TR(10),FORCP(10),TEMPP(10),COVP(
     &10)
      DIMENSION CHWP(10),RHOP(10),GAMAP(10),NPERFS(10),GLENP(10),PDPI(1
     &0),PDPO(10),GDIAP(10),DBPCP(10),ALPHA(10,10),BETA(10,10),PRES(10,
     &10)
      DIMENSION A(4),B(4),AK(4),D(20),Y(20),P(20),Z(20),FRAC(10),SURF(1
     &0),NBR(10),IBO(10)
      REAL LAMBDA,J1ZP,J2ZP,J3ZP,J4ZP
      DIMENSION CHDIST(5),CHDIAM(5),BINT(4)
C     CALL GETTIM(IHR,IMIN,ISEC,IHUNS)
      PI=3.14159
      WRITE(*,15)
15    FORMAT(' INPUT NAME OF DATA FILE TO BE USED AS INPUT ')
      READ(*,10)BDFILE
10    FORMAT(A10)
      OPEN(UNIT=2,ERR=999,FILE=BDFILE,STATUS='OLD',IOSTAT=IOS)
      REWIND 2
      WRITE(*,25)
25    FORMAT(' INPUT NAME OF OUTPUT FILE ')
      READ(*,10)OUTFIL
      OPEN(UNIT=3,ERR=998,FILE=OUTFIL,STATUS='NEW')
      WRITE(3,16)BDFILE
16    FORMAT(' THE INPUT FILE IS ',A10)
      READ(2,*,END=20,ERR=30)CHAM,GRVE,ALAND,GLR,TWST,TRAVP,IGRAD
      IF(IGRAD.GT.1)GO TO 51
      WRITE(3,55)
55    FORMAT(1X,'USING LAGRANGE PRESSURE GRADIENT')
      GO TO 52
C     DEFINE CHAMBRAGE ASSUMES NCHPTS=NUMBER OF POINTS TO DEFINE
C     CHAMBER > OR = 2 < OR = 5 (?),CHDIAM(I) DEFINES CHAMBER DIAMETER 
C     AT CHDIST (I) CHAMBER DISTANCE. CHIDIAM(NCHPTS) IS ASSUMED TO BE
C     THE BORE DIAMETER AND CHDIST(I) IS ASSUMED TO BE -, I.E. AT THE
C     BREECH. ASSUMES TRUNCATED CONES.
51    WRITE(3,47,ERR=30)
47    FORMAT(1X,'USING CHAMBRAGE PRESSURE GRADIENT')
      READ(2,*,END=20,ERR=30)NCHPTS,(CHDIST(I),CHDIAM(I),I=1,NCHPTS)
      WRITE(3,53,ERR=30)(CHDIST(I),CHDIAM(I),I=1,NCHPTS)
53    FORMAT(///,'   CHAMBER DISTANCE CM   CHAMBER DIAMETER CM',/(5X,E1
     &4.6,5X,E14.6))
      DO 54 I=1,NCHPTS
      CHDIST(I)=0.01*CHDIST(I)
54    CHDIAM(I)=0.01*CHDIAM(I)
C     CALCULATE CHAMBER INTEGRALS AND VOLUME
      IF(NCHPTS.GT.5) WRITE(3,44,ERR=30)
44    FORMAT(1X,'USE FIRST 5 POINTS')
      IF(NCHPTS.GT.5)NCHPTS=5
      BORE=CHDIAM(NCHPTS)
      IF(CHDIST(1).NE.0.0)WRITE(3,45,ERR=30)
45    FORMAT(1X,' # POINTS ? ')
C     PAGE 15
      CHDIST(1)=0.0
      PI3=PI/3.0
      B1=0.0
      B2=0.0
      B3=0.0
      B4=0.0
      POINTS=25.0
56    POINTS=POINTS+POINTS
      STEP=CHDIST(NCHPTS)/POINTS
      ZZ=0.0
      BINT(1)=0.0
      BINT(3)=0.0
      BINT(4)=0.0
      BVOL=0.0
      R2=0.5*CHDIAM(1)
      K=1
      J=INT(POINTS+0.5)
      DO 57 I=1,J
      ZZ=ZZ+STEP
      IF(K.EQ.NCHPTS-1)GO TO 46
      DO 58 I1=K,NCHPTS-1
      IF (ZZ.GT.CHDIST(I1).AND. ZZ.LT.CHDIST(I1+1))GO TO 59
58    CONTINUE
      I1=NCHPTS-1
59    K=I1
46    DIAM=(ZZ-CHDIST(K))/(CHDIST(K+1)-CHDIST(K))
      DIAM=CHDIAM(K)+DIAM*(CHDIAM(K+1)-CHDIAM(K))
      R1=0.5*DIAM
      AREA=PI*(R1+R2)*(R1+R3)/4.
      BVOL=BVOL+STEP*PI3*(R1*R1+R1*R2+R2*R2)
      BINT(1)=BINT(1)+STEP*BVOL/AREA
      BINT(3)=BINT(3)+STEP*AREA*BINT(1)
      BINT(4)=BINT(4)+STEP*BVOL*BVOL/AREA
57    R2=R1
      TEMP=ABS(1.0-B1/BINT(1))
      IF(ABS(1.0-B3/BINT(3)).GT.TEMP)TEMP=ABS(1.0-B3/BINT(3))
      IF(ABS(1.0-B4/BINT(4)).GT.TEMP)TEMP=ABS(1.0-B4/BINT(4))
      IF(TEMP.LE.0.001)GO TO 41
      B1=BINT(1)
      B3=BINT(3)
      B4=BINT(4)
      GO TO 56
41    CHAM=BVOL*1.E6
C     WRITE(3,47,ERR=30)BINT(1),BINT(3),BINT(4)
C     FORMAT(1X,'BINT 1 = ',E14.6,' BINT 3 = ',E14.6,' BINT 4 = ',E14.&
C    &6)
      CHMLEN=CHDIST(NCHPTS)
52    WRITE(3,40,ERR=30)CHAM,GRVE,ALAND,GLR,TWST,TRAVP
40    FORMAT(1X,'CHAMBER VOLUME CM**3',E14.6,/' GROOVE DIAM CM',E14.6,/
     &' LAND DIAM CM',E14.6,/' GROOVE/LAND RATIO',E14.6,/' TWIST TURNS/
     &CALIBER ',E14.6,/' PROJECTILE TRAVEL CM', E14.6///)
      CHAM=CHAM*1.E-6
      GRVE=GRVE*1.E-2
      ALAND=ALAND*1.E-2
      TRAVP=TRAVP*1.E-2
C     PAGE 16
      READ(2,*,END=20,ERR=30)PRWT,IAIR,HTFR,PGAS
      WRITE(3,50,ERR=30)PRWT,IAIR,HTFR,PGAS
50    FORMAT(1X,'PROJECTILE MASS KG',E14.6,/' SWITCH TO CALCULATE ENERG
     &Y LOST TO AIR RESISTANCE J',I2,/' FRACTION OF WORK AGAINST BORE U
     &SED TO HEAT THE TUBE',E14.6/1X,' GAS PRESSURE PA' ,E14.6)
     
      READ(2,*,END=20,ERR=30)NPTS,(BR(I),TRAV(I),I=1,NPTS)
      WRITE(3,60,ERR=30)NPTS,(BR(I),TRAV(I),I=1,NPTS)
60    FORMAT(1X,'NUMBER BARREL RESISTANCE POINTS',I2,/' BORE RESISTANCE
     & MPA - TRAVEL CM'/(1X,E14.6,E14.6))
      WRITE(3,65)
      DO 62 I=1,NPTS
      BR(I)=BR(I)*1.E6
      TRAV(I)=TRAV(I)*1.E-2
62    CONTINUE
65    FORMAT(1X)
      READ(2,*,END=20,ERR=30)RCWT,NRP,(RP(I),TR(I),I=1,NRP)
      WRITE(3,70,ERR=30)RCWT,NRP,(RP(I),TR(I),I=1,NRP)
70    FORMAT(1X,' MASS OF RECOILING PARTS KG',E14.6,/' NUMBER OF RECOIL
     &POINT PAIRS',I2,/' RECOIL FORCE N',' RECOIL TIME SEC'/,(1X,E14.6,
     &3X,E14.6))
      WRITE(3,65)
      READ(2,*,END=20,ERR=30)HO,TSHL,CSHL,TWAL,HL,RHOCS
      WRITE(3,75,ERR=30)HO,TSHL,CSHL,TWAL,HL,RHOCS
75    FORMAT(1X,' FREE CONVECTIVE HEAT TRANSFER COEFFICIENT WCM**2 K',E
     &14.6,/' CHAMBER WALL THICKNESS CM',E14.6,/' HEAT CAPACITY OF STEE
     &L OF CHAMBER WALL J/G K',E14.6,/' INITIAL TEMPERATURE OF CHAMBER 
     &WALL K',E14.6,/' HEAT LOSS COEFFICIENT',E14.6,/' DENSITY OF CHAMB
     &ER WALL STEEL G/CM**3',E14.6//)
      HO=HO/1.E-4
      TSHL=TSHL*1.E-2
      CSHL=CSHL*1.E+3
      RHOCS=RHOCS*1.E-3/1.E-6
      READ(2,*,END=20,ERR=30)FORCIG,COVI,TEMPI,CHWI,GAMAI
      WRITE(3,85,ERR=30)FORCIG,COVI,TEMPI,CHWI,GAMAI
85    FORMAT(1X,' IMPETUS OF IGNITER PROPELLANT J/G',E14.6,/' COVOLUME 
     &OF IGNITER CM**3/G',E14.6,/' ADIABATIC FLAME TEMPERATURE OF IGNIT 
     &ER PROPELLANT K',E14.6,/' INITIAL MASS OF IGNITER KG',E14.6,/' RA
     &TIO OF SPECIFIC HEATS FOR IGNITER',E14.6//)
      FORCIG=FORCIG*1.E+3
      COVI=COVI*1.E-6/1.E-3
      READ(2,*,END=20,ERR=30)NPROP,(FORCP(I),TEMPP(I),COVP(I),CHWP(I),R
     &HOP(I),GAMAP(I),NPERFS(I),GLENP(I),PDPI(I),PDPO(I),GDIAP(I),DBPCP
     &(I),I=1,NPROP)
      WRITE(3,95,ERR=30)(I,FORCP(I),TEMPP(I),COVP(I),CHWP(I),RHOP(I),GA
     &MAP(I),NPERFS(I),GLENP(I),PDPI(I),PDPO(I),GDIAP(I),DBPCP(I),I=1,N
     &PROP)
95    FORMAT((' FOR PROPELLANT NUMBER',I2,/' IMPETUS OF PROPELLANT J/G'
     &,E14.6,/' ADIABATIC TEMPERATURE OF PROPELLANT K',E14.6,/' COVOLUM
     &E OF PROPELLANT CM**3/G',E14.6/' INITIAL MASS OF PROPELLANT KG',E
     &14.6,/' DENSITY OF PROPELLANT G/CM**#',E14.6' RATIO OF SPECIFIC H
     &EATS FOR PROPELLANT',E14.6/' NUMBER OF PERFORATIONS OF PROPELLANT
     &',I2/' LENGTH OF PROPELLANT GRAIN CM',E14.6/' DIAMETETER OF INNER
     &PERFORATION IN PROPELLANT GRAINS CM',E14.6/' DIAMETER OF OUTER PE
     &RFORATION OF PROPELLANT GRAINS CM',E14.6/' OUTSIDE DIAMETER OF PR
C     PAGE 17
     &OPELLANT GRAIN CM',E14.6/' DISTANCE BETWEEN PERF CENTERS CM',E14.
     &6)//)
      TMPI=0.0
      DO 96 I=1,NPROP
      FORCP(I)=FORCP(I)*1.E+3
      COVP(I)=COVP(I)*1.E-6/1.E-3
      RHOP(I)=RHOP(I)*1.E-3/1.E-6
      GLENP(I)=GLENP(I)*0.01
      PDPI(I)=PDPI(I)*0.01
      PDPO(I)=PDPO(I)*0.01
      GDIAP(I)=GDIAP(I)*0.01
      DBPCP(I)=DBPCP(I)*0.01
      TMPI=TMPI+CHWP(I)
96    CONTINUE
      TMPI=TMPI+CHWI
      DO 97 J=1,NPROP
      READ(2,*,END=20,ERR=30)NBR(J),(ALPHA(J,I),BETA(J,I),PRES(J,I),I=1
     &,NBR(J))
110   FORMAT(1X,'NUMBER OF BURNING RATE POINTS',I2/3X,' EXPONENT',8X,' 
     &COEFFICIENT',10X,' PRESSURE'/5X,'-',15X,'CM/SEC-MPA**AI',10X,'MPA
     &',/(1X,E14.6,5X,E14.6,15X,E14.6))
      DO 112 I=1,NBR(J)
      BETA(J,I)=BETA(J,I)*1.E-2
      PRES(J,I)=PRES(J,I)*1.E6
112   CONTINUE
97    CONTINUE
      WRITE(3,65)
      READ(2,*,END=20,ERR=30)DELTAT,DELTAP,TSTOP
      WRITE(3,120,ERR=30)DELTAT,DELTAP,TSTOP
120   FORMAT(1X,'TIME INCREMENT MSEC',E14.6' PRINT INCREMENT MSEC',E14.
     &6/1X,'TIME TO STOP CALCULATION MSEC ',E14.6)
      WRITE(*,130)
      DELTAT=DELTAT*0.001
      DELTAP=DELTAP*0.001
      TSTOP=STOP*.001
130   FORMAT(1X,'THE DATA HAS BEEN READ')
      IF(IGRAD.GT.1)GO TO 131
      BORE=(GLR*GRVE*GRVE+ALAND*ALAND)/(GLR+1.)
      BORE=SQRT(BORE)
131   AREAB=PI*BORE*BORE/4.
      LAMBDA=1./((13.2+4.*LOG10(100.*BORE))**2)
      PMAXM=0.0
      PMAXBR=0.0
      PMAXBA=0.0
      TPMAXM=0.0
      TPMAXBR=0.0
      TPMAXBA=0.0
      TPMAX=0.0
      A(1)=0.5
      A(2)=1.-SQRT(2.)/2.
      A(3)=1.+SQRT(2.)/2.
      A(4)=1./6.
      B(1)=2.
C     PAGE 18
      B(2)=1.
      B(3)=1.
      B(4)=2.
      AK(1)=0.5
      AK(2)=A(2)
      AK(3)=A(3)
      AK(4)=0.5
      VP0=0.0
      TR0=0.0
      TCW=0.0
      DO 5 I=1,NPROP
      IBO(I)=0
5     VP0=CHWP(I)/RHOP(I)+VP0
      VOLGI=CHAM-VP0-CHWI*COVI
      PMEAN=FORCIG*CHWI/VOLGI
      VOLG=VOLGI
      VOLGI=VOLGI+VP0
      WALLT=TWAL
      PTIME=0.0
      IBRP=8
      Z(3)=1.
      NDE=IBRP+NPROP
      WRITE(3,132)AREAB,PMEAN,VP0,VOLGI
132   FORMAT(1X,'AREA BORE M^2 ',E16.6,' PRESSURE FROM IGN PA',E16.6,/1
     &X,' VOLUME OF UNBURNT PROP M^3 ',E16.6,' INIT CHAM VOL-COV IGN M^
     &3 ',E16.6)
      WRITE(3,6)
6     FORMAT(1X,'     TIME       ACC      VEL      DIS      MPRESS     
     &      PBASE       PBRCH       ')
      ISWL=0
19    CONTINUE
      DO 11 J=1,4
C     FIND BARREL RESISTANCE
      DO 201 K=2, NPTS
      IF(Y(2)+Y(7).GE.TRAV(K))GO TO 201
      GO TO 203
201   CONTINUE
      K=NPTS
203   RESP=(TRAV(K)-Y(2)-Y(7))/(TRAV(K)-TRAV(K-1))
      RESP=BR(K)-RESP*(BR(K)-BR(K-1))
C     FIND MASS FRACTION BURNING RATE
      DO 211 K=1, NPROP
      IF(IBO(K).EQ.1)GOTO211
      CALL PRF017(PDPO(K),PDPI(K),GDIAP(K),DBPCP(K),GLENP(K),SURF(K),FR
     &AC(K),Y(IBRP+K),NPERFS(K),U)
      IF(SURF(K).LT.1.E-10) IBO(K)=1
211   CONTINUE
      K=NPROP
C     ENERGY LOSS TO PROJECTILE TRANSLATION
      ELPT=PRWT*Y(1)*Y(1)/2.
C     ENERGY LOSS DUE TO PROJECTILE ROTATION
      ELPR=PI*PI*PRWT*Y(1)*Y(1)/4.*TWST*TWST
C     ENERGY LOSS DUE TO GAS AND PROPELLANT MOTION
      IF(IGRAD.LE.1)GO TO 214
      PT=Y(2)+Y(7)
C     PAGE 19
      VZP=BVOL+AREAB*PT
      J4ZP=BINT(4)+((BVOL+AREAB*PT)**3-BVOL**3)/3./AREAB/AREAB
      ELGPM=TMPI*Y(1)*Y(1)*AREAB*AREAB*J4ZP/2./VZP/VZP/VZP
      GO TO 216
214   ELGPM=TMPI*Y(1)*Y(1)/6.
C     ENERGY LOSS FROM BORE RESISTANCE
216   ELBR=Y(4)
      Z(4)=AREAB*RESP*Y(1)
C     ENERGY LOSS DUE TO RECOIL
      ELRC=RCWT*Y(6)*Y(6)/2
C     ENERGY LOSS DUE TO HEAT LOSS
      AREAW=CHAM/AREAB*PI*BORE+2.*AREAB+PI*BORE*(Y(2)+Y(7))
      AVDEN=0.0
      AVC=0.0
      AVCP=0.0
      Z18=0
      Z19=0
      DO 213 K=1,NPROP
      Z18=FORCP(K)*GAMAP(K)*CHWP(K)*FRAC(K)/(GAMAP(K)-1.)/TEMPP(K)+Z18
      Z19=CHWP(K)*FRAC(K)+Z19
      AVDEN=AVDEN+CHWP(K)*FRAC(K)
213   CONTINUE
      AVCP=(Z18+FORCIG*GAMAI*CHWI/(GAMAI-1.)/TEMPI)/(Z19+CHWI)
      AVDEN=(AVDEN+CHWI)/(VOLG+COV1)
      AVVEL=.5*Y(1)
      HTNS=LAMBDA*AVCP*AVDEN*AVVEL+HO
      Z(5)=AREAW*HTNS*(TGAS-WALLT)*HL
      ELHT=Y(5)
      WALLT=(ELHT+HTFR*ELBR)/CSHL/RHOCS/AREAW/TSHL+TWAL
C     WRITE(3,*)LAMBDA,AVCP,AVDEN,AVVEL,HO,AREAW,HTNS,TGAS,WALLT,HL,Z(5)
C    &,ELHT
C     ENERGY LOSS DUE TO AIR RESISTANCE
      AIR=IAIR
      Z(8)=Y(1)*PGAS*AIR
      ELAR=AREAB*Y(8)
C     RECOIL
      Z(6)=0.0
      IF(PBRCH.LE.RP(1)/AREAB)GO TO 221
      RFOR=RP(2)
      IF(Y(3)-TR0.GE.TR(2))GO TO 222
      RFOR=(TR(2)-(Y(3)-TR0))/(TR(2)-TR(1))
      RFOR=RP(2)-RFOR*(RP(2)-RP(1))
222   Z(6)=AREAB/RCWT*(PBRCH-RFOR/AREAB-RESP)
      IF(Y(6).LT.0.0)Y(6)=0.0
      Z(7)=Y(6)
      GOTO 223
221   TR0=Y(3)
223   CONTINUE
C     CALCULATE GAS TEMPERATURE
      EPROP=0.0
      RPROP=0.0
      DO 231 K=1,NPROP
      EPROP=EPROP+FORCP(K)*CHWP(K)*FRAC(K)/(GAMAP(K)-1.)
      RPROP=RPROP+FORCP(K)*CHWP(K)*FRAC(K)/(GAMAP(K)-1.)/TEMPP(K)
231   CONTINUE
C     PAGE 20
      TENERGY=ELPT+ELPR+ELGPM+ELBR+ELRC+ELHT+ELAR
      TGAS=(EPROP+FORCIG*CHWI/(GAMAI-1.)-ELPT-ELPR-ELGPM-ELBR-ELRC-ELHT
     &-ELAR)/(RPROP+FORCIG*CHWI/(GAMAI-1.)/TEMPI)
C     FIND FREE VOLUME
      V1=0.0
      COV1=0.0
      DO 241 K=1, NPROP
      V1=CHWP(K)*(1.-FRAC(K))/RHOP(K)+V1
      COV1=COV1+CHWP(K)*COVP(K)*FRAC(K)
241   CONTINUE
      VOLG=VOLGI+AREAB*(Y(2)+Y(7))-V1-COV1
C     CALCULATE MEAN PRESSURE
      R1=0.0
      DO 251 K=1,NPROP
      R1=R1+FORCP(K)*CHWP(K)*FRAC(K)/TEMPP(K)
251   CONTINUE
      PMEAN=TGAS/VOLG*(R1+FORCIG*CHWI/TEMPI)
      RESP=RESP+PGAS*AIR
      IF(IGRAD.LE.1)GO TO 252
      IF(ISWL.NE.0)GO TO 253
      PBASE=PMEAN
      PBRCH=PMEAN
      IF(PBASE.GT.RESP+1.)ISWL=1
      GO TO 257
C     USE CHAMBRAGE PRESSURE GRADIENT EQUATION
253   J1ZP=BINT(1)+(BVOL*PT+AREAB/2.*PT*PT)/AREAB
      J2ZP=(BVOL+AREAB*PT)**2/AREAB/AREAB
      J3ZP=BINT(3)+AREAB*BINT(1)*PT+BVOL*PT*PT/2.+AREAB*PT*PT*PT/6.
      A2T=-TMPI*AREAB*AREAB/PRWT/VZP/VZP
      ALF=1.-A2T*J1ZP
      ALT=TMPI*AREAB*(AREAB*Y(1)*Y(1)/VZP+AREAB*RESP/PRWT)/VZP/VZP
      BT=-TMPI*Y(1)*Y(1)*AREAB*AREAB/2./VZP/VZP/VZP
      BATA=-ALT*JLZP-BT*J2ZP
      GAMMA=ALF+A2T*J3ZP/VZP
      DELTA=BATA+ALT*J3ZP/VZP+BT*J4ZP/VZP
C     CALCULATE BASE PRESSURE
      PBASE=(PMEAN-DELTA)/GAMMA
C     CALCULATE BREECH PRESSURE
      PBRCH=ALF*PBASE+BATA
      GO TO 254
C     USE LAGRANGE PRESSURE GRADIENT EQUATION
252   IF(ISWL.NE.0)GO TO 256
      IF(PMEAN.LT.RESP)RESP=PMEAN
C     CALCULATE BASE PRESSURE
256   PBASE=(PMEAN+TMPI*RESP/3./PRWT)/(1.+TMPI/3./PRWT)  
      IF(PBASE.GT.RESP+1.)ISWL=1
C     CALCULATE BREECH PRESSURE
      PBRCH=PBASE+TMPI/2./PRWT*(PBASE-RESP)
C     CALCULATE PROJECTILE ACCELERATION
254   Z(1)=AREAB*(PBASE-RESP)/PRWT
      IF(Z(1).LT.0.0)GO TO 257
      GO TO 258
257   IF(ISWL.EQ.0)Z(1)=0.0
258   IF(Y(1).LT.0.0)Y(1)=0.0
      Z(2)=Y(1)
C     PAGE 21
C     GET BURNING RATE
      DO 264 M=1,NPROP
      Z(IBRP+M)=0.0
      IF(IBO(M).EQ.1) GOTO 264
      DO 262 K=1,NBR(M)
      IF(PMEAN.GT.PRES(M,K))GO TO 262
      GO TO 263
262   CONTINUE
      K=NBR(M)
263   Z(IBRP+M)=BETA(M,K)*(PMEAN*1.E-6)**ALPHA(M,K)
264   CONTINUE
      DO 21 I=1,NDE
      D(I)=(Z(I)-B(J)*P(I))*A(J)
      Y(I)=DELTAT*D(I)+Y(I)
      P(I)=3.*D(I)-AK(J)*Z(I)+P(I)
21    CONTINUE
11    CONTINUE
      T=T+DELTAT
      IF(PMAXM.GT.PMEAN)GO TO 281
      PMAXM=PMEAN
      TPMAXM=Y(3)
281   IF(PMAXBA.GT.PBASE)GO TO 282
      PMAXBA=PBASE
      TPMAXBA=Y(3)
282   IF(PMAXBR.GT.PBRCH)GO TO 283
      PMAXBR=PBRCH
      TPMAXBR=Y(3)
283   CONTINUE
      IF(Y(3).LT.PTIME)GO TO 272
      PTIME=PTIME+DELTAP
      WRITE(3,7)Y(3),Z(1),Y(1),Y(2),PMEAN,PBASE,PBRCH
7     FORMAT(1X,7E11.4)
316   FORMAT(1X)
272   CONTINUE
      IF(T.GT.TSTOP)GOTO 200
      IF(Y(2).GT.TRAVP)GO TO 200
      RMVELO=Y(1)
      TMVELO=Y(3)
      DISTO=Y(2)
      GO TO 19
200   WRITE(3,311)T,Y(3)
311   FORMAT(1X,' DELTAT T', E14.6,' INTG T',E14.6)
      WRITE(3,312)PMAXM,TPMAXM
312   FORMAT(1X,'PMAXMEAN P ',E14.6,' TIME AT PMAXMEAN SEC ',E14.6)
      WRITE(3,313)PMAXBA,TPMAXBA
313   FORMAT(1X,'PMAXBASE PA ',E14.6,' TIME AT PMAXBASE SEC ',E14.6)
      WRITE(3,314)PMAXBR,TPMAXBR
314   FORMAT(1X,'PMAXBREECH PA ',E14.6,' TIME AT PMAXBREECH SEC ',E14.6
     &)
      IF(Y(2).LE.TRAVP)GO TO 303
      DFRACT=(TRAVP-DISTO)/(Y(2)-DISTO)
      RMVEL=(Y(1)-RMVELO)*DFRACT+RMVELO
      TMVEL=(Y(3)-TMVELO)*DRAFCT+TMVELO
      WRITE(3,318)RMVEL,TMVEL
318   FORMAT(1X,'MUZZLE VELOCITY M/S ',E14.6,' TIME OF MUZZLE VELOCITY 
     &SEC ',E14.6)
C     PAGE 22
      GOTO 319
303   WRITE(3,327)Y(1),Y(3)
327   FORMAT(1X,'VELOICTY OF PROJECTILE M/S ',E14.6,' AT THIS TIME MSEC
     &',E14.6)
319   EFI=CHWI*FORCIG/(GAMAI-1.)
      EFP=0.0
      DO 315 I=1,NPROP
      EFP=EFP+CHWP(I)*FORCP(I)/(GAMAP(I)-1.0)
315   CONTINUE
      TENERG=EFI+EFP
      WRITE(3,317)TENERG
317   FORMAT(1X,'TOTAL INITIAL ENERGY AVAILABLE J = ',E14.6)
      TENGAS=CHWI*FORCIG*TGAS/(GAMAI-1.)/TEMPI
      DO 135 I=1,NPROP
      TENGAS=(FRAC(I)*CHWP(I)*FORCP(I)*TGAS/TEMPP(I)/(GAMAP(I)-1.))+TEN
     &GAS
      WRITE(3,328)I,FRAC(I)
328   FORMAT(' FOR PROPELLANT ',I2,' MASSFRACT BURNT IS ',E14.6)
135   CONTINUE
      WRITE(3,136)TENGAS
136   FORMAT(1X,'TOTAL ENERGY REMAINING IN GAS J= ',E14.6)
      WRITE(3,320)ELPT
320   FORMAT(1X,'ENERGY LOSS FROM PROJECTILETRANSLATION J= ',E14.6)
      WRITE(3,321)ELPR
321   FORMAT(1X,'ENERGYLOSS FROM PROJECTILE RORATION J= ',E14.6)
      WRITE(3,322)ELGPM
322   FORMAT(1X,'ENERGY LOST TO GAS AND PROPELLANT MOTION J= ',E14.6)
      WRITE(3,323)ELBR
323   FORMAT(1X,'ENERGY LOST TO BORE RESISTANCE J ',E14.6)
      WRITE(3,324)ELRC
324   FORMAT(1X,'ENERGY LOST TO RECOIL J= ',E14.6)
      WRITE(3,325)ELHT
325   FORMAT(1X,'ENERGY LOSS FROM HEAT TRANSFER J= ',E14.6)
      WRITE(3,326)ELAR
326   FORMAT(1X,'ENERGY LOST TO AIR RESISTANCE J= ',E14.6)
C     CALL GETTIM(IHRO,IMINO,ISECO,IHUNSO)
C     TIME=(IHRO-IHR)*3600.+(IMINO-IMIN)*60.+(ISECO-ISEC)+(IHUNSO-INHUN
C    &S)/100.
C     WRITE(3,*)TIME
      STOP
20    WRITE(*,140)
140   FORMAT(1X,'END OF FILE ENCOUNTER')
      STOP
30    WRITE(*,150)
999   CONTINUE
998   CONTINUE
150   FORMAT(1X,'READ OR WRITE ERROR')
      STOP
      END
C
      SUBROUTINE PRF017(P,P1,D,D1,L,SURF,MASSF,X,NP,U)
      IMPLICIT REAL*4(A-Z)
C     
C     P=OUTER PERF DIA
C     P1=INNER PERF DIA
C     D=OUTER DIA
C     PAGE 23
C     D1=DISTANCE BETWEEN PERF CENTRES
C     L=GRAIN LENGTH
C     NP=NUMBER OF PERFS
C
C     SURF=OUTPUT SURFACE AREA
C     MASSF=OUTPUT MASS FRACTION OF PROPELLANT BURNER
C
C     W=WEB BETWEEN OUTER PERFS
C     W0=OUTER WEB
C     W1=WEB BETWEEN OUTER AND INNER PERFS
C     W4=MINIMUM WEB
      INTEGER ITYM,NP
      DATA PI,SQRT3/3.14159,1.732051/,ITYM/0/
      DATA HAFPI,PIFOR,TWOPI/1.570796,.785398,6.283185/
C
      IF(ITYM.GT.0)GO TO 10
      P1SQ=P1*P1
      DISQ=D1*D1
      PSQ=P*P
      DSQ=D*D
      D1SQ3=DI*SQRT3
      D2SQ3=D1SQ*SQRT3
      IF(NP.EQ.0)GO TO 2000
      IF(NP.EQ.1)GO TO 3000
      IF(NP.NE.7)GO TO 60
      IF(P1.GT.(P+D1*(SQRT3-1))) GO TO 60
      IF(D.GE.D1*(SQRT3+1.)-P)GO TO 130
60    WRITE(6,90)
90    FORMAT(1X,'UNACCEPTABLE GRANULATION')
      STOP
130   W=D1-P
      IF(W.LT.0)GO TO 60
      W0=(D-P-2.*D1)/2.
      IF(W.LT.0.)GO TO 60
      W1=(2.*D1-P-P1)/2.
      IF(W1.LT.0.)GO TO 60
      X1=(P1SQ-PSQ+4.*D1SQ-2.*P1*D1SQ3)/4./(D1SQ3+P-P1)
      X2=(4.*D1SQ+D*D-2.*D*D1SQ3-PSQ)/4./(-D1SQ3+P+D)
      A=PI*L*(D+P1+6.*P)+HAFPI*(DSQ-P1SQ-6.*PSQ)
      U=PI*L/4.*(DSQ-P1SQ-6.*PSQ)
      W4=AMIN1(W,W0,W1)
10    MASSF=0.
      TWOX=X+X
      XSQ=X*X
      P1P2X=P1+TWOX
      PP2X=P+TWOX
      DM2X=D-TWOX
      LM2X=L-TWOX
      P12XSQ=P1P2X*P1P2X
      PP2XSQ=PP2X*PP2X
      IF(NP.EQ.0)GO TO 2000
      IF(NP.EQ.1)GO TO 3000
      IF(IM2X.GT.0)GO TO 340
C     PAGE 24
      SURF=0
      V=0
      GO TO 850
340   S0=PI*LM2X*LM2X*(D+P1+6.*P+12.*X)+HAFPI*(DM2X*DM2X-P1P2X*P1P2X-6.
     &*PP2X*PP2X)
      V0=PIFOR*LM2X*(DM2X*DM2X-P1P2X*P1P2X-6.*PP2X*PP2X)
      IF(X.GT.W4/2.)GO TO 360
      MASSF=-TWOX/L/(DSQ-P1SQ-6.*PSQ)
      MASSF=MASSF*(24.*XSQ+(24.*P+4.*P1+4.*D-12.*L)*X+P1SQ+6.*PSQ-2.*L*
     &D-2.*P1*L-12.*L*P-DSQ)
      SURF=S0
      RETURN
360   IF(X.GT.W1/2.)GO TO 390
      F2=0.
      L2=0.
      A3=0.
      A4=0.
      GO TO 460
390   Z=(2.*D1+P+P1+4.*X)/4
      B3=((P1-P)*(P1+P+4.*X)+4.*D1SQ)/4./D1/P1P2X
      A3=ATAN(SQRT(1.-B3*B3)/B3)
      B4=((P-P1)*(P+P1+4.*X)+4.*D1SQ)/4./D1/PP2X
      A4=ATAN(SQRT(1.-B4*B4)/B4)
      F2=AR/4.*P12XSQ+A4/4.*PP2XSQ-SQRT(Z*(Z-D1)*(2.*Z-P-TWOX)*(2.*Z-P1
     &-TWOX))
      L2=LM2X*(A4*PP2X+A3*P1P2X)
460   IF(X.GT.W/2.)GO TO 490
      F3=0.
      L3=0.
      A5=0.
      GO TO 530
490   B5=D1/PP2X
      A5=ATAN(SQRT(1.-B5*B5)/B5)
      F3=(A5*PP2XSQ-D1*SQRT(PP2XSQ-D1SQ))/2
      L3=2.*A5*LM2X*PP2X
530   IF(X.GT.W0/2.)GO TO 560
      F1=0.
      L1=0.
      A1=0.
      A2=0.
      GO TO 650
560   Y=(2.*D1+P+D)/4.
      B1=((D+P)*(D-P-4.*X)-4.*D1SQ)/4./D1/PP2X
      A1=ATAN(SQRT(1.-B1*B1)/B1)
      IF(A1.GT.0.)GO TO 610
      A1=PI+A1
610   B2=((D+P)*(D-P-4.*X)+4.*D1SQ)/4./D1/DM2X
      A2=ATAN(SQRT(1.-B2*B2)/B2)
      F1=A1/4.*PP2XSQ-A2/4.*DM2XSQ+SQRT(Y*(Y-D1)*(2.*Y-P-TWOX)*(2.*Y-D+
     &TWOX))
      L1=LM2X*(A1*PP2X+A2*DM2X)
650   IF(X.GT.W/2.)GO TO 690
      SURF=S0+12.*(F1+F2+F3)-6.*(L1+L2+L3)
      V=V0+6.*(F1+F2+F3)*LM2X
      GO TO 850
C     PAGE 25
690   IF(X.LT.X1)GO TO 730
      S1=0.0
      V1=0.0
      GO TO 760
730   S1=3.*D2SQ3-PI*PP2XSQ-HAFPI*P12XSQ+6.*F3+12.*F2
      S1=S1+LM2X*(2.*(PI-3.*A5-3.*A4)*PP2X+(PI-6.*A3)*P1P2X)
      V1=LM2X/2.*(3.*D2SQ3-PI*PP2XSQ-HAFPI*P12XSQ+6.*F3+12.*F2)
760   IF(X.LT.X2) GO TO 800
      S2=0.0
      V2=0.0
      GO TO 830
800   S2=HAFPI*DM2XSQ-3.*D2SQ3-TWOPI*PP2XSQ+12.*F1+6.*F3
      S2=S2+LM2X*((PI-6.*A2)*DM2X+2.*(TWOPI-3.*A1-3.*A5)*PP2X)
      V2=LM2X/2.*(HAFPI*DM2XSQ-3.*D2SQ3-TWOPI*PP2XSQ+12.*F1+6.*F3)
830   SURF=S1+S2
      V=V1+V2
850   MASSF=1.-V/U
      RETURN
C
C     ZERO PERF CALCULATIONS START HERE
C
2000  IF(D-2*X.LE.0.0) GO TO 2001
      TWOX=X+X
      XSQ=X*X
      MASSF=TWOX*(DSQ+2.*L*D-4.*X*D-TWOX*L+4.*XSQ)/(DSQ*L)
      U=DSQ*L*PI/4.
      SURF=PI*(DSQ/2.-4.*D*X-TWOX*L+D*L+6.*XSQ)
      RETURN
2001  SURF=0.0
      MASSF=1.0
      U=DSQ*L*PI/4
      RETURN
C
C     ONE PERF CALCULATIONS START HERE
C
3000  IF(D-P-4.*X.LE.0.) GO TO 3001
      TWOX=X+X
      MASSF=TWOX*(DSQ+2.*L*D-4.*X*D-PSQ+2.*P*L-4.*P*X)/(DSQ*L-PSQ*L)
      U=DSQ*L*PI/4.-PSQ*L*PI/4.
3001  SURF=0.0
      MASSF=1.0
      U=DSQ*L*PI/4.-PSQ*L*PI/3
      RETURN
      
      END
